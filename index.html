<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
    <title>GLP V13.1 Refactored</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://em-content.zobj.net/source/apple/354/fire_1f525.png">
    <link rel="icon" type="image/png" href="https://em-content.zobj.net/source/apple/354/fire_1f525.png">
    
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
</head>
<body>

    <div class="version-tag">GLP V13.1 (Refactored)</div>
    
    <div id="toast">
        <span id="toast-icon"></span>
        <span id="toast-text"></span>
    </div>

    <div class="identity-bar">
        <div class="user-info" onclick="window.location.reload()"> <div class="avatar" id="avatar-initial">?</div>
            <div>
                <div class="username" id="username-display">Caricamento...</div>
                <div class="level-badge" id="level-display">Livello --</div>
            </div>
        </div>
        <div class="coins-display">
            <span class="coin-icon">ü™ô</span>
            <span id="score-flavio" style="color:#ffca28; margin-right:8px">--</span>
            <span style="color:#666">|</span>
            <span id="score-simona" style="color:#d05ce3; margin-left:8px">--</span>
        </div>
    </div>

    <div class="date-nav">
        <button class="nav-btn" onclick="window.changeDate(-1)">
            <span class="material-icons-round">chevron_left</span>
        </button>
        <div class="current-date">
            <h2 id="dateDisplay">OGGI</h2>
            <input type="date" id="datePicker" onchange="window.goToDate(this.value)">
        </div>
        <button class="nav-btn" onclick="window.changeDate(1)">
            <span class="material-icons-round">chevron_right</span>
        </button>
    </div>

    <div class="daily-summary">
        <div class="summary-item">
            <span class="summary-val success" id="sum-earn">+0</span>
            <span class="summary-label">Guadagnati</span>
        </div>
        <div class="summary-item">
            <span class="summary-val danger" id="sum-spent">-0</span>
            <span class="summary-label">Spesi</span>
        </div>
        <div class="summary-item">
            <span class="summary-val" id="sum-net" style="color:#fff">0</span>
            <span class="summary-label">Netto</span>
        </div>
    </div>

    <div class="tab-menu">
        <button class="tab-btn active" onclick="window.switchTab('dashboard')">
            <span class="material-icons-round">list_alt</span>
            Home
        </button>
        <button class="tab-btn" onclick="window.switchTab('shop')">
            <span class="material-icons-round">shopping_cart</span>
            Shop
        </button>
        <button class="tab-btn" onclick="window.switchTab('analytics')">
            <span class="material-icons-round">insights</span>
            Stats
        </button>
    </div>

    <div id="main-content" style="padding-bottom: 20px;">
        
        <div id="view-dashboard" class="view-section active">
            
            <div id="habitList" class="habit-list">
                <div style="text-align:center; padding:30px; color:#666">
                    Caricamento dati...
                </div>
            </div>

            <hr style="border:0; border-top:1px solid #333; margin:20px 0;">

            <div class="section-title">Programmate / Uniche</div>
            <div id="upcomingList" class="habit-list"></div>

            <button class="fab" onclick="window.openEditModal(null, 'habit')">
                <span class="material-icons-round">add</span>
            </button>
        </div>

        <div id="view-shop" class="view-section" style="display:none;">
            <div class="shop-header">
                <h3>üõçÔ∏è Negozio Ricompense</h3>
                <p style="font-size:0.9em; color:#888">Spendi i tuoi punti saggiamente.</p>
            </div>
            <div id="shopList" class="habit-list">
                </div>
            
            <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
            <h3>üõí Storico Acquisti (Oggi)</h3>
            <div id="purchaseHistoryList" class="habit-list"></div>
        </div>

        <div id="view-analytics" class="view-section" style="display:none;">
            
            <div class="chart-container">
                <h3>Andamento Punti</h3>
                <div class="switch-group" style="margin-bottom:15px;">
                    <div class="switch-opt" id="filter7" onclick="window.updateDetailedChart(7)">7 GG</div>
                    <div class="switch-opt" id="filter14" onclick="window.updateDetailedChart(14)">14 GG</div>
                    <div class="switch-opt active" id="filter30" onclick="window.updateDetailedChart(30)">30 GG</div>
                </div>
                <div style="flex:1; position:relative; min-height:200px;">
                    <canvas id="detailedChart"></canvas>
                </div>
                <div id="nodeInfo" style="margin-top:15px; padding:15px; background:rgba(255,255,255,0.05); border-radius:10px; display:none;">
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #444; padding-bottom:5px; margin-bottom:5px;">
                        <strong id="nodeDate" style="color:var(--text)">--</strong>
                        <div>
                            <span style="color:#ffca28">F</span> <span id="nodeValFlavio">0</span> | 
                            <span style="color:#d05ce3">S</span> <span id="nodeValSimona">0</span>
                        </div>
                    </div>
                    <div id="nodeNote" style="font-style:italic; color:#aaa; font-size:0.9em;"></div>
                </div>
            </div>

            <div class="chart-container" style="margin-top:20px">
                <h3>Distribuzione Punti (30gg)</h3>
                <div style="position:relative; height:250px; display:flex; justify-content:center">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>

        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Modifica</h3>
                <button class="btn-icon-minimal" onclick="window.closeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="text" id="edit-name" placeholder="Nome Attivit√†/Reward" class="modal-input">
                <input type="text" id="edit-desc" placeholder="Descrizione (Opzionale)" class="modal-input">
                
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div style="flex:1">
                        <label>Punti / Costo</label>
                        <input type="number" id="edit-val" class="modal-input">
                    </div>
                    <div style="flex:1" id="edit-val-min-wrapper">
                        <label>Min Punti</label>
                        <input type="number" id="edit-val-min" class="modal-input">
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-top:10px;">
                    <select id="edit-tag" class="modal-input"></select>
                    <select id="edit-freq" class="modal-input">
                        <option value="daily">Ogni Giorno</option>
                        <option value="weekly">Settimanale</option>
                        <option value="single">Data Singola</option>
                    </select>
                </div>

                <div style="margin-top:15px; display:flex; gap:20px; align-items:center;">
                    <label style="display:flex; align-items:center; gap:5px;">
                        <input type="checkbox" id="edit-multi"> Multi (Min/Max)
                    </label>
                    <label style="display:flex; align-items:center; gap:5px;">
                        <input type="checkbox" id="edit-penalty"> Penalit√† se saltata
                    </label>
                </div>

                <div id="edit-date-wrapper" style="margin-top:10px; display:none;">
                    <label>Data Target</label>
                    <input type="date" id="edit-target-date" class="modal-input">
                </div>

                <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center">
                    <button id="btn-archive" class="btn-danger" style="display:none;" onclick="window.archiveItem()">Archivia</button>
                    <button class="btn-primary" onclick="window.saveItem()">Salva</button>
                </div>
            </div>
        </div>
    </div>

    <div style="text-align:center; margin-top:40px; color:#444;">
        <button class="btn-text" onclick="window.switchUser('flavio')">Passa a Flavio</button> | 
        <button class="btn-text" onclick="window.switchUser('simona')">Passa a Simona</button>
        <p style="font-size:10px; margin-top:10px">GLP PWA - Time Travel Enabled</p>
    </div>

    <script type="module" src="main.js"></script>

</body>
</html>