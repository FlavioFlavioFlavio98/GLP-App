<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
    <title>GLP V14.5</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://em-content.zobj.net/source/apple/354/fire_1f525.png">
    <link rel="stylesheet" href="style.css?v=15.0">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
</head>
<body>

    <div id="debug-error" style="background:red; color:white; padding:10px; display:none;"></div>

    <div class="identity-bar">
        <div class="user-info">
            <div class="avatar" id="userAvatar">F</div>
            <span class="username" id="userNameDisplay">Flavio</span>
        </div>
        <div style="display:flex; align-items:center;">
            <span class="offline-badge">OFFLINE</span>
            <button class="settings-btn" onclick="location.href='settings.html'">
                <span class="material-icons-round">settings</span>
            </button>
        </div>
    </div>

    <div class="dashboard-top">
        <div class="progress-container">
            <svg class="progress-ring" width="100" height="100">
                <circle class="progress-ring__circle-bg" stroke="#333" stroke-width="8" fill="transparent" r="42" cx="50" cy="50"/>
                <circle id="prog-circle" class="progress-ring__circle" stroke="#ffca28" stroke-width="8" fill="transparent" r="42" cx="50" cy="50" style="stroke-dasharray: 263; stroke-dashoffset: 263;"/>
            </svg>
            <span class="progress-text" id="prog-text">0%</span>
        </div>

        <div class="scoreboard-mini">
            <div class="score-row" onclick="switchUser('flavio')">
                <span>Flavio</span>
                <strong style="color:var(--theme-color)" id="score-flavio">...</strong>
            </div>
            <div class="score-row" onclick="switchUser('simona')">
                <span>Simona</span>
                <strong style="color:#d05ce3" id="score-simona">...</strong>
            </div>
        </div>
    </div>

    <div class="controls">
        <div class="date-nav">
            <button class="nav-arrow" onclick="changeDate(-1)">&#8249;</button>
            <span id="dateDisplay">OGGI</span>
            <button class="nav-arrow" onclick="changeDate(1)">&#8250;</button>
        </div>
        <div class="btn-icon-bg" onclick="renderView()">
            <span class="material-icons-round">refresh</span>
        </div>
    </div>

    <div id="habitList">
        <div style="text-align:center; padding:20px; color:#666;">Caricamento...</div>
    </div>

    <h3 class="section-title">Condizionali (IF)</h3>
    <div id="ifList"></div>

    <h3 class="section-title">Ricompense</h3>
    
    <button class="accordion" onclick="toggleShop()">
        Negozio Premi <span class="material-icons-round">expand_more</span>
    </button>
    <div id="shopPanel" class="panel">
        <div id="shopList">
            </div>
    </div>

    <div class="chart-box" id="chartSection" style="margin-bottom: 80px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span style="font-weight:bold; color:#888;">Andamento Punti</span>
        </div>
        
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <div class="switch-opt" id="filter7" onclick="if(window.updateDetailedChart) window.updateDetailedChart(7)">7 GG</div>
            <div class="switch-opt" id="filter14" onclick="if(window.updateDetailedChart) window.updateDetailedChart(14)">14 GG</div>
            <div class="switch-opt active" id="filter30" onclick="if(window.updateDetailedChart) window.updateDetailedChart(30)">30 GG</div>
        </div>

        <div style="flex:1; position:relative; min-height:0;">
            <canvas id="detailedChart"></canvas>
        </div>
        
        <div id="nodeInfo" style="margin-top:15px; padding:15px; background:rgba(255,255,255,0.05); border-radius:10px; display:none;">
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #444; padding-bottom:5px; margin-bottom:5px;">
                <strong id="nodeDate" style="color:var(--text)">--</strong>
                <div><span style="color:#ffca28">F</span> <span id="nodeValFlavio">0</span> | <span style="color:#d05ce3">S</span> <span id="nodeValSimona">0</span></div>
            </div>
            <div id="nodeNote" style="font-style:italic; color:#aaa; font-size:0.9em;"></div>
        </div>
    </div>

    <div id="fab" class="fab" onclick="location.href='add.html'">+</div>

    <div id="toast"><span id="toast-icon"></span> <span id="toast-text"></span></div>

    <div class="version-tag">v14.5 (Fix)</div>

    <script type="module" src="app.js?v=15.0"></script>
    
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((reg) => console.log('SW registrato:', reg.scope))
                    .catch((err) => console.log('SW fallito:', err));
            });
        }

        // Rilevamento stato offline/online
        window.addEventListener('online', () => document.body.classList.remove('offline'));
        window.addEventListener('offline', () => document.body.classList.add('offline'));
        
        // Debug Errori su Mobile
        window.onerror = function(msg, url, line) {
            const d = document.getElementById('debug-error');
            d.style.display = 'block';
            d.innerText = `Error: ${msg} (Line ${line})`;
        };
    </script>
</body>
</html>