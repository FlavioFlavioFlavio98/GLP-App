<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
    <title>GLP V10.0</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://em-content.zobj.net/source/apple/354/fire_1f525.png">

    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
</head>
<body>
    <div class="version-tag">GLP V10.0 (Stats & Polish)</div>
    <div id="toast"><span id="toast-icon">‚úÖ</span><span id="toast-text">Messaggio</span></div>

    <div class="identity-bar">
        <div class="offline-badge">OFFLINE</div>
        <div class="user-info"><div class="avatar" id="avatar-initial">F</div><div class="username" id="username-display">Flavio</div></div>
        <button class="settings-btn" onclick="document.getElementById('settingsModal').style.display='flex'"><span class="material-icons-round">settings</span></button>
    </div>

    <div class="dashboard-top">
        <div class="progress-container">
            <svg class="progress-ring" width="100" height="100"><circle stroke="#2a2a2a" stroke-width="8" fill="transparent" r="42" cx="50" cy="50"/><circle id="prog-circle" class="progress-ring__circle" stroke="var(--theme-color)" stroke-width="8" fill="transparent" r="42" cx="50" cy="50" stroke-dasharray="263" stroke-dashoffset="263" stroke-linecap="round"/></svg>
            <div class="progress-text" id="prog-text">0%</div>
        </div>
        <div class="scoreboard-mini">
            <div class="score-row" id="card-flavio" onclick="switchUser('flavio')"><span>Flavio</span><strong id="score-flavio">--</strong></div>
            <div class="score-row" id="card-simona" onclick="switchUser('simona')"><span>Simona</span><strong id="score-simona">--</strong></div>
        </div>
    </div>

    <div class="chart-box"><canvas id="progressChart"></canvas></div>
    
    <div class="date-nav">
        <button class="date-btn" onclick="changeDate(-1)">&#8249;</button>
        <div class="current-date-wrapper">
            <span class="current-date" id="dateDisplay">OGGI</span>
            <input type="date" id="datePicker" onchange="goToDate(this.value)">
        </div>
        <button class="date-btn" onclick="changeDate(1)">&#8250;</button>
    </div>

    <div class="daily-summary">
        <div class="sum-item">
            <div class="sum-label">Guadagnati</div>
            <div class="sum-val earn" id="sum-earn">0</div>
        </div>
        <div class="sum-item">
            <div class="sum-label">Spesi/Pen</div>
            <div class="sum-val spent" id="sum-spent">0</div>
        </div>
        <div class="sum-item">
            <div class="sum-label">Netto</div>
            <div class="sum-val" id="sum-net">0</div> </div>
    </div>

    <div id="mainContent">
        <h2>ABITUDINI DEL GIORNO</h2>
        <div id="habitList"></div>
        
        <button class="accordion" onclick="toggleAccordion('upcomingList')"><span>üìÖ In Programma</span><span class="material-icons-round">expand_more</span></button>
        <div class="panel" id="upcomingList"><div style="text-align:center; color:#555; padding:10px;">Niente in programma</div></div>

        <h2>ACQUISTI DEL GIORNO</h2>
        <div id="purchasedList"><div style="color:#666; font-size:0.9em; text-align:center; padding:10px;">Nessun acquisto oggi</div></div>

        <button class="accordion" onclick="toggleAccordion('shopPanel')" style="margin-top:20px"><span>üõçÔ∏è Negozio Premi</span><span class="material-icons-round">expand_more</span></button>
        <div class="panel" id="shopPanel">
            <div id="shopList"></div>
        </div>
    </div>

    <div class="fab" onclick="document.getElementById('addModal').style.display='flex'"><span class="material-icons-round">add</span></div>

    <div id="addModal" class="modal">
        <div class="modal-box">
            <h3 style="color:var(--theme-color)">Nuovo Elemento</h3>
            
            <div class="switch-group">
                <div class="switch-opt active" id="typeHabit" onclick="setAddType('habit')">Abitudine</div>
                <div class="switch-opt" id="typeReward" onclick="setAddType('reward')">Premio</div>
            </div>

            <input type="text" id="newName" placeholder="Nome">
            <select id="newTag" class="full"><option value="">Nessun Tag</option></select>

            <div id="habitInputs">
                <div class="switch-group" style="margin-top:5px">
                    <div class="switch-opt active" id="modeRecur" onclick="setRecurMode('recur')">Ricorrente</div>
                    <div class="switch-opt" id="modeSingle" onclick="setRecurMode('single')">Singolo Giorno</div>
                </div>

                <div id="recurInput">
                    <label style="font-size:0.8em; color:#888">Ogni quanto?</label>
                    <select id="newFrequency" class="full">
                        <option value="1">Ogni Giorno</option>
                        <option value="3">Ogni 3 Giorni</option>
                        <option value="7">Settimanale</option>
                        <option value="30">Mensile</option>
                    </select>
                </div>

                <div id="dateInput" style="display:none">
                    <label style="font-size:0.8em; color:#888">Data esecuzione</label>
                    <input type="date" id="newTargetDate" class="full">
                </div>

                <div class="grid-2">
                    <input type="number" id="newReward" placeholder="Punti (+)">
                    <input type="number" id="newPenalty" placeholder="Penalit√† (-)">
                </div>
            </div>
            
            <div id="rewardInputs" style="display:none"><input type="number" id="newCost" placeholder="Costo"></div>
            
            <button class="btn-main" onclick="addItem()">Salva</button>
            <button class="btn-sec" onclick="document.getElementById('addModal').style.display='none'">Chiudi</button>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-box">
            <h3><span class="material-icons-round">edit</span> Modifica</h3>
            
            <div class="input-group">
                <label style="font-size:0.8em; color:#888;">Data della modifica (per storico)</label>
                <input type="date" id="editDate" class="full">
            </div>

            <div class="input-group">
                <label style="font-size:0.8em; color:#888;">Nome</label>
                <input type="text" id="editName">
            </div>

            <div class="input-group">
                <label style="font-size:0.8em; color:#888;">Tag</label>
                <select id="editTag" class="full"><option value="">Nessun Tag</option></select>
            </div>

            <div class="grid-2">
                <div class="input-group" id="editValGroup1">
                    <label id="editLabel1" style="font-size:0.8em; color:#888;">Reward</label>
                    <input type="number" id="editVal1">
                </div>
                <div class="input-group" id="editValGroup2">
                    <label id="editLabel2" style="font-size:0.8em; color:#888;">Penalty</label>
                    <input type="number" id="editVal2">
                </div>
            </div>

            <div class="input-group">
                <label style="font-size:0.8em; color:#888;">Nota (Opzionale)</label>
                <textarea id="editNote" placeholder="Es. Aumentato perch√© pi√π faticoso..." class="full" rows="2"></textarea>
            </div>

            <div class="history-list" id="editHistoryLog"></div>

            <button class="btn-main" onclick="saveEdit()">Salva Modifiche</button>
            <button class="btn-danger" style="margin-top:30px; border-color: #d32f2f; background: rgba(211, 47, 47, 0.1);" onclick="archiveFromEdit()">Archivia / Elimina</button>
            <button class="btn-sec" onclick="document.getElementById('editModal').style.display='none'">Annulla</button>
        </div>
    </div>

    <div id="archiveModal" class="modal">
        <div class="modal-box">
            <h3><span class="material-icons-round">archive</span> Archivia</h3>
            <p style="color:#aaa; font-size:0.9em">Da quale data vuoi smettere di vedere questo elemento?</p>
            <input type="date" id="archiveDate" class="full">
            <button class="btn-danger" onclick="confirmArchive()">Archivia definitivamente</button>
            <button class="btn-sec" onclick="document.getElementById('archiveModal').style.display='none'">Annulla</button>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-box" style="text-align:center">
            <h3>Impostazioni</h3>
            <button class="btn-backup" onclick="openStats()">üìä Statistiche</button>
            <button class="btn-backup" onclick="openTagManager()">üè∑Ô∏è Gestisci Tag</button>
            <hr style="border:1px solid #333; margin:20px 0;">
            <button class="btn-backup" onclick="exportData()"><span class="material-icons-round">download</span> Esporta Backup</button>
            <button class="btn-backup" onclick="document.getElementById('importFile').click()"><span class="material-icons-round">upload</span> Ripristina Backup</button>
            <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(this.files)">
            <hr style="border:1px solid #333; margin:20px 0;">
            <button class="btn-danger" onclick="hardReset()">‚ò¢Ô∏è RESET APP</button>
            <button class="btn-sec" onclick="document.getElementById('settingsModal').style.display='none'">Chiudi</button>
        </div>
    </div>

    <div id="tagModal" class="modal">
        <div class="modal-box">
            <h3>Gestisci Tag</h3>
            <div id="tagsList" style="max-height:200px; overflow-y:auto; margin-bottom:15px"></div>
            <div style="background:#2a2a2a; padding:10px; border-radius:10px; border:1px solid #444">
                <input type="text" id="newTagName" placeholder="Nome Tag" style="margin-top:0">
                <input type="color" id="newTagColor" value="#3498db" style="width:100%; height:40px; border:none; margin:5px 0">
                <button id="btnSaveTag" class="btn-main" style="margin-top:5px" onclick="saveTagManager()">Crea Tag</button>
            </div>
            <button class="btn-sec" onclick="document.getElementById('tagModal').style.display='none'">Chiudi</button>
        </div>
    </div>

    <div id="statsModal" class="modal">
        <div class="modal-box" style="max-width:450px;">
            <h3>üìä Statistiche Utente</h3>
            <div id="statsContent" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                </div>
            <button class="btn-sec" onclick="document.getElementById('statsModal').style.display='none'">Chiudi</button>
        </div>
    </div>

    <script type="module" src="app.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW ok:', reg.scope))
                    .catch(err => console.log('SW err:', err));
            });
        }
    </script>
</body>
</html>