<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#121212" />
  <title>GLP V14.6</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="https://em-content.zobj.net/source/apple/354/fire_1f525.png" />
  <link rel="stylesheet" href="style.css?v=14.6" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
</head>
<body>
  <div id="debug-error" style="background:#b00020; color:white; padding:10px; display:none;"></div>
  <script>
    window.onerror = function(msg, url, line) {
      const box = document.getElementById('debug-error');
      box.style.display = 'block';
      box.innerHTML = "ERRORE: " + msg + " (Riga " + line + ")";
    };
  </script>

  <div class="version-tag">GLP V14.6 (If Habits)</div>

  <div id="toast"><span id="toast-icon">‚úÖ</span><span id="toast-text">Messaggio</span></div>

  <div class="identity-bar">
    <div class="offline-badge">OFFLINE</div>
    <div class="user-info">
      <div class="avatar" id="avatar-initial">F</div>
      <div class="username" id="username-display">Flavio</div>
    </div>
    <button class="settings-btn" onclick="document.getElementById('settingsModal').style.display='flex'">
      <span class="material-icons-round">settings</span>
    </button>
  </div>

  <div class="dashboard-top">
    <div class="progress-container">
      <svg class="progress-ring" width="100" height="100">
        <circle stroke="#2a2a2a" stroke-width="8" fill="transparent" r="42" cx="50" cy="50"></circle>
        <circle id="prog-circle" class="progress-ring__circle" stroke="var(--theme-color)" stroke-width="8" fill="transparent" r="42" cx="50" cy="50" stroke-dasharray="263" stroke-dashoffset="263" stroke-linecap="round"></circle>
      </svg>
      <div class="progress-text" id="prog-text">0%</div>
    </div>

    <div class="scoreboard-mini">
      <div class="score-row" id="card-flavio" onclick="switchUser('flavio')"><span>Flavio</span><strong id="score-flavio">--</strong></div>
      <div class="score-row" id="card-simona" onclick="switchUser('simona')"><span>Simona</span><strong id="score-simona">--</strong></div>
    </div>
  </div>

  <div class="chart-box">
    <canvas id="multiChart"></canvas>
  </div>

  <div class="date-nav">
    <button class="date-btn" onclick="changeDate(-1)">&#8249;</button>
    <div class="current-date-wrapper">
      <span class="current-date" id="dateDisplay">OGGI</span>
      <input type="date" id="datePicker" onchange="goToDate(this.value)">
    </div>
    <button class="date-btn" onclick="changeDate(1)">&#8250;</button>
  </div>

  <div class="daily-summary">
    <div class="sum-item"><div class="sum-label">Guadagnati</div><div class="sum-val earn" id="sum-earn">0</div></div>
    <div class="sum-item"><div class="sum-label">Spesi/Pen</div><div class="sum-val spent" id="sum-spent">0</div></div>
    <div class="sum-item"><div class="sum-label">Netto</div><div class="sum-val" id="sum-net">0</div></div>
  </div>

  <div id="mainContent">
    <div class="note-container">
      <label style="font-size:0.8em; color:#888; margin-left:5px;"><span class="material-icons-round" style="font-size:12px; vertical-align:middle">group</span> Diario di Bordo</label>
      <textarea id="dailyNoteArea" class="shared-note-area" placeholder="Scrivi una nota." oninput="handleNoteInput(this.value)"></textarea>
      <div id="noteStatus" style="font-size:0.7em; color:#666; text-align:right; margin-top:2px; height:15px;"></div>
    </div>

    <h2>ABITUDINI DEL GIORNO</h2>
    <div id="habitList"></div>

    <button class="accordion" onclick="toggleAccordion('ifPanel')"><span>ü§∑‚Äç‚ôÇÔ∏è Abitudini Se/If (Bonus)</span><span class="material-icons-round">expand_more</span></button>
    <div class="panel" id="ifPanel">
      <div id="ifList"></div>
    </div>

    <h2>ACQUISTI DEL GIORNO</h2>
    <div id="purchasedList"><div class="empty">Nessun acquisto oggi</div></div>

    <button class="accordion" onclick="toggleAccordion('shopPanel')" style="margin-top:20px"><span>üõçÔ∏è Negozio Premi</span><span class="material-icons-round">expand_more</span></button>
    <div class="panel" id="shopPanel">
      <div id="shopList"></div>
    </div>
  </div>

  <div class="fab" onclick="document.getElementById('addModal').style.display='flex'"><span class="material-icons-round">add</span></div>

  <!-- ADD MODAL -->
  <div id="addModal" class="modal">
    <div class="modal-box">
      <h3 style="color:var(--theme-color)">Nuovo Elemento</h3>

      <div class="switch-group">
        <div class="switch-opt active" id="typeHabit" onclick="setAddType('habit')">Abitudine</div>
        <div class="switch-opt" id="typeReward" onclick="setAddType('reward')">Premio</div>
      </div>

      <input type="text" id="newName" placeholder="Nome">
      <input type="text" id="newDesc" placeholder="Breve descrizione (opzionale)" class="full">

      <div id="habitInputs">
        <div class="grid-2">
          <div class="input-group"><label style="font-size:0.8em; color:#888;">Reward (MAX)</label><input type="number" id="newReward" placeholder="+"></div>
          <div class="input-group"><label style="font-size:0.8em; color:#888;">Penalit√† (FAIL)</label><input type="number" id="newPenalty" placeholder="-"></div>
        </div>

        <div style="margin:10px 0; display:flex; align-items:center; gap:10px; background:#2a2a2a; padding:10px; border-radius:8px;">
          <input type="checkbox" id="newIsMulti" style="width:20px; height:20px; margin:0;" onchange="toggleMultiInput('new')">
          <label for="newIsMulti" style="font-size:0.9em;">Abilita MIN (Reward Min)</label>
        </div>

        <div id="newMinInputGroup" class="input-group" style="display:none;">
          <label style="font-size:0.8em; color:var(--theme-color);">Reward (MIN)</label>
          <input type="number" id="newRewardMin" placeholder="+ (min)">
        </div>

        <div class="switch-group" style="margin-top:10px">
          <div class="switch-opt active" id="modeRecur" onclick="setRecurMode('recur')">Ricorr.</div>
          <div class="switch-opt" id="modeSingle" onclick="setRecurMode('single')">Singolo</div>
          <div class="switch-opt" id="modeIf" onclick="setRecurMode('if')">If (Bonus)</div>
        </div>
        <div id="dateInput" style="display:none"><input type="date" id="newTargetDate" class="full"></div>
      </div>

      <div id="rewardInputs" style="display:none">
        <div class="input-group"><label style="font-size:0.8em; color:#888;">Costo</label><input type="number" id="newCost" placeholder="-"></div>
      </div>

      <button class="btn-main" onclick="addItem()">Salva</button>
      <button class="btn-sec" onclick="closeModal('addModal')">Chiudi</button>
    </div>
  </div>

  <!-- SETTINGS MODAL (minimal) -->
  <div id="settingsModal" class="modal">
    <div class="modal-box">
      <h3>‚öôÔ∏è Impostazioni</h3>
      <button class="btn-backup" onclick="forceReload()">üîÑ Forza aggiornamento (pulisci cache)</button>
      <button class="btn-sec" onclick="closeModal('settingsModal')">Chiudi</button>
    </div>
  </div>

  <script type="module" src="app.js?v=14.6"></script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }

    function toggleAccordion(id) {
      const panel = document.getElementById(id);
      if (!panel) return;
      panel.classList.toggle('show');
    }
  </script>
</body>
</html>
